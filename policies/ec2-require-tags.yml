policies:

- name: ec2-tag-noncompliance-mark-shutdown
  resource: ec2
  comments: |
    Schedule a resource that does not meet tag compliance policies
    to be stopped in one day.
  filters:
    - State.Name: running
    - "tag:aws:autoscaling:groupName": absent
    - "tag:maid_status": absent
    - "tag:BusinessUnit": absent
    - "tag:Environment": absent
    - "tag:Project": absent
    - "tag:OwnerEmail": absent

  actions:
    - type: notify
      template_format: html
      template: /custodian/email/jinja_template.j2
      subject: "URGENT: Your AWS EC2 Resources will be shutdown tomorrow!"
      to:
        - resource-owner
        - ldap_uid_tags
      transport:
        type: sqs
        queue: https://sqs.us-east-1.amazonaws.com/172119256206/cloudcustodian-mailer-devtest
    - type: mark-for-op
      op: stop
      days: 1 

- name: ec2-tag-compliance-unmark
  resource: ec2
  description: |
    Any instances which have previously been marked as
    non compliant with tag policies, that are now compliant
    should be unmarked as non-compliant.
  filters:
    - State.Name: running
    - and:
      - "tag:aws:autoscaling:groupName": absent
      - "tag:maid_status": not-null
      - "tag:BusinessUnit": not-null
      - "tag:Environment": not-null
      - "tag:Project": not-null
      - "tag:OwnerEmail": not-null
  actions:
    - unmark

- name: ec2-tag-noncompliance-mark-terminate
  resource: ec2
  comments: |
    Terminate any instances violating the tagging policy 2 days after initially found.
  filters:
    - type: marked-for-op
      op: stop
  actions:
    - stop
    - type: notify
      template_format: html
      template: /custodian/email/jinja_template.j2
      subject: "URGENT: Your AWS EC2 Resources will be terminated tomorrow!"
      to:
        - resource-owner
        - ldap_uid_tags
      transport:
        type: sqs
        queue: https://sqs.us-east-1.amazonaws.com/172119256206/cloudcustodian-mailer-devtest
    - type: mark-for-op
      op: terminate
      days: 1

- name: ec2-tag-noncompliance-terminate
  resource: ec2
  comment: |
    Terminate all instances previously markedfor termination by today's date.
  filters:
    - type: marked-for-op
      op: terminate 
  actions:
    - terminate
